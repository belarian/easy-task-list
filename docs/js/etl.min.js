(function(){"use strict";if(typeof window.localforage=="undefined"){console.error("The Object 'localforage' is not available!\n"+"More info: https://localforage.github.io/localForage/");return}if(typeof window.jQuery=="undefined"){console.error("The Object 'jQuery' is not available!");return}if(typeof window.Sortable=="undefined"){console.error("The Object 'Sortable' is not available!\n"+"More info: https://github.com/RubaXa/Sortable");return}if(typeof window.Mustache=="undefined"){console.error("The Object 'Mustache' is not available!\n"+"More info: https://github.com/janl/mustache.js");return}if(typeof window.docCookies=="undefined"){console.error("The Object 'DocCookies' is not available!\n"+"More info: https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie/Simple_document.cookie_framework");return}var localforage=window.localforage,$=window.jQuery,Sortable=window.Sortable,Mustache=window.Mustache,DocCookies=window.docCookies,document=window.document,navigator=window.navigator;var Event=new function(){var list={};this.on=function(handlerName,element){var handler=list[handlerName];if(typeof handler=="undefined"){console.error("There is no event handler with a name: "+handlerName);return this}if(handler.type=="event"){element.addEventListener(handler.event,handler.fn,handler.useCapture)}else if(handler.type=="observer"){handler.observer.observe(element,handler.config)}return this};this.off=function(handlerName,element){var handler=list[handlerName];if(typeof handler=="undefined"){console.error("There is no event handler with a name: "+handlerName);return this}if(handler.type=="event"){element.removeEventHandler(handler.event,handler.fn,handler.useCapture)}else if(handler.type=="observer"){handler.observer.disconect()}return this},this.registerHandler=function(handlerName,event,fn,useCapture){useCapture=useCapture||false;list[handlerName]={type:"event",event:event,fn:fn,useCapture:useCapture};return this},this.registerObserver=function(observerName,config,fn){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;list[observerName]={type:"observer",config:config,observer:new MutationObserver(fn)};return this},this.unregisterHandler=function(handlerName){delete list[handlerName]},this.unregisterObserver=function(observerName){delete list[observerName]},this.get=function(handlerName){return list[handlerName]}};var Helper=function(){function getDocumentHeight(){return Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)}function setDocumentHeight(){document.body.style["height"]=getDocumentHeight()+"px"}function unsetDocumentHeight(){document.body.style["height"]=""}function appendHtml(element,html){var temp=document.createElement("DIV");temp.innerHTML=html;element.appendChild(temp.firstElementChild);return element.lastElementChild}return{setDocumentHeight:setDocumentHeight,unsetDocumentHeight:unsetDocumentHeight,appendHtml:appendHtml}}();var Locale=function(){var acceptedLanguages=["en","bg"],language=DocCookies.getItem("lang")||findAcceptableLanguage(),collection=JSON.parse(document.getElementById("locale-"+language).innerText);collection["navbar"]["currentLanguage"]=language;collection["navbar"]["acceptedLanguages"]=acceptedLanguages;function findAcceptableLanguage(){var lang=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;if(!lang||acceptedLanguages.indexOf(lang)==-1)lang=acceptedLanguages[0];DocCookies.setItem("lang",lang,15768e3);return lang}document.title=collection.title;document.getElementById("navbar").innerHTML=Mustache.render(document.getElementById("navbar-template").innerText,collection.navbar);Event.registerHandler("changeLanguage","click",function(e){var lang;if(e.target.nodeName=="I"){lang=e.target.getAttribute("data-lang")}else if(e.target.nodeName=="A"){lang=e.target.firstElementChild.getAttribute("data-lang")}if(lang){DocCookies.setItem("lang",lang,15768e3)}}).on("changeLanguage",document.getElementById("change-language"));return{collection:collection}}();var Storage=function(){localforage.getItem("index").then(function(value){if(value==null){localforage.setItem("index",0);localforage.setItem("0",{id:"0",dependent:[]})}}).catch(function(err){console.error(err)});function select(id,fn){localforage.getItem(id).then(fn).catch(function(err){console.error(err)})}function insert(data,fn){localforage.getItem("index").then(function(index){var newIndex=++index+"";localforage.setItem("index",index);data["id"]=newIndex;localforage.setItem(newIndex,data).then(fn).catch(function(err){console.error(err)});localforage.getItem(data["dependence"]).then(function(data){data["dependent"].push(newIndex);localforage.setItem(data["id"],data).catch(function(err){console.error(err)})}).catch(function(err){console.error(err)})}).catch(function(err){console.error(err)})}function update(id,newData,fn){localforage.getItem(id).then(function(data){for(var prop in newData){if(data.hasOwnProperty(prop)){if(typeof newData[prop]=="function")data[prop]=newData[prop](data[prop]);else data[prop]=newData[prop]}else console.error("There is no name property: "+prop+"!")}localforage.setItem(data["id"],data).then(fn).catch(function(err){console.error(err)})}).catch(function(err){console.error(err)})}function remove(id,fn){localforage.removeItem(id).then(fn).catch(function(err){console.error(err)})}return{select:select,insert:insert,update:update,delete:remove}}();var Modal=function(){var formSelector="modal-form",containerElement=document.getElementById("modal-container"),template=document.getElementById("modal-template").innerText;Mustache.parse(template);function load(data,extraData){if(extraData){for(var key in extraData){data[key]=extraData[key]}}containerElement.innerHTML=Mustache.render(template,data);$(containerElement).modal("show")}function unload(){$(containerElement).modal("hide");containerElement.innerHTML=""}var buttonAction=function(){function create(){var form=document.forms[formSelector].elements;Task.create({id:"",title:form["title"].value,description:form["description"].value,dependence:form["dependence"].value,dependent:[],status:1})}function update(){var form=document.forms[formSelector].elements;Task.update({id:form["id"].value,title:form["title"].value,description:form["description"].value})}function remove(){var form=document.forms[formSelector].elements;Task.remove({id:form["id"].value,dependence:form["dependence"].value})}return{create:create,update:update,delete:remove}}();Event.registerHandler("preventModalSubmit","submit",function(e){e.preventDefault();document.getElementById("modalSubmit").click()}).on("preventModalSubmit",containerElement);Event.registerHandler("createProjectButton","click",function(e){load(Locale.collection["project"]["create"],{dependence:"0"})}).on("createProjectButton",document.getElementById("create-project-button"));Event.registerHandler("modalButtons","click",function(e){if(e.target.nodeName=="BUTTON"){if(e.target.type=="submit"){buttonAction[e.target.getAttribute("data-action")]()}unload()}}).on("modalButtons",containerElement);Event.registerObserver("autofocusModalInputField",{childList:true},function(mutations){var input=mutations[0].target.querySelector("[autofocus]");if(input)setTimeout(function(){input.select()},850)}).on("autofocusModalInputField",containerElement);return{load:load,unload:unload}}();var Task=function(){var template={project:document.getElementById("project-template").innerText,task:document.getElementById("task-template").innerText};var groupElements={},currentScreenWidth=document.documentElement.clientWidth,lastMoveOverElement=null,listenEvent,delay=0;if("ontouchstart"in window){listenEvent="touchstart";delay=300}else if("onpointerdown"in window){listenEvent="pointerdown"}else if("onmousedown"in window){listenEvent="mousedown"}Mustache.parse(template.project);Mustache.parse(template.task);function create(data){Storage.insert(data,function(data){put(data)})}function update(data){Storage.update(data["id"],data,function(data){var element=document.getElementById("title-"+data["id"]);if(element.childElementCount)element.firstElementChild.innerText=data["title"];else element.innerText=data["title"];element.title=data["description"]})}function remove(data){Storage.select(data["id"],function deleteRecursive(data){data["dependent"].forEach(function(id){Storage.select(id,deleteRecursive)});delete groupElements[data["id"]];Storage.delete(data["id"])});Storage.update(data["dependence"],{dependent:function(dependent){dependent.splice(dependent.indexOf(data["id"]),1);return dependent}});getGroupElement(data["dependence"]).removeChild(document.getElementById("item-"+data["id"]));Helper.unsetDocumentHeight()}function toggleStatus(btn){var id=btn.getAttribute("data-item-id");Storage.update(id,{status:function(status){return+!status}},function(data){if(data["dependence"]=="0"){if(data["status"]==0)btn.classList.add("inactive");else btn.classList.remove("inactive");Helper.unsetDocumentHeight()}else{var text;if(data["status"]==0){btn.classList.remove("btn-secondary");btn.classList.add("btn-success");btn.firstElementChild.innerHTML='<use class="svg" xlink:href="#check" x="0" y="0"></use>';text=document.getElementById("title-"+id);text.innerHTML="<del>"+text.innerText+"</del>"}else{btn.classList.remove("btn-success");btn.classList.add("btn-secondary");btn.firstElementChild.innerHTML='<use class="svg svg-light-bg" xlink:href="#eye" x="0" y="0"></use>';text=document.getElementById("title-"+id);text.innerHTML=text.innerText}}})}function toggleButtons(btn){var element=document.getElementById(btn.getAttribute("data-target"));if(element.classList.contains("act-btns-show"))element.classList.remove("act-btns-show");else element.classList.add("act-btns-show")}var buttonAction=function(){function after(btn){if(currentScreenWidth<993){setTimeout(function(){btn.parentElement.classList.remove("act-btns-show")},500)}}function create(btn){var dependence=btn.getAttribute("data-dependence");Modal.load(Locale.collection[getType(dependence)]["create"],{dependence:dependence});after(btn)}function edit(btn){var id=btn.getAttribute("data-item-id");Storage.select(id,function(data){Modal.load(Locale.collection[getType(data.dependence)]["edit"],data)});after(btn)}function remove(btn){var dependence=btn.getAttribute("data-dependence"),id=btn.getAttribute("data-item-id");Modal.load(Locale.collection[getType(dependence)]["delete"],{id:id,dependence:dependence});after(btn)}return{create:create,edit:edit,delete:remove,toggleStatus:toggleStatus,toggleButtons:toggleButtons}}();function getType(id){return id=="0"?"project":"task"}function getGroupElement(id){if(id in groupElements)return groupElements[id];return groupElements[id]=document.getElementById("group-"+id)}function put(data){var type=getType(data["dependence"]),html=Mustache.render(template[type],data),element=Helper.appendHtml(getGroupElement(data["dependence"]),html);makeSortable(getGroupElement(data["id"]));data["dependent"].forEach(function(id){Storage.select(id,put)})}function makeSortable(element,group){group=group||"task";Sortable.create(element,{group:group,animation:258,delay:delay,filter:function(e){e.stopPropagation();var btn;if(e.type==listenEvent){switch(e.target.nodeName.toUpperCase()){case"BUTTON":btn=e.target;break;case"H3":btn=e.target.parentElement;break;case"SVG":btn=e.target.parentElement;break;case"USE":btn=e.target.parentElement.parentElement}if(btn&&btn.nodeName=="BUTTON"){e.preventDefault();buttonAction[btn.getAttribute("data-action")](btn);return true}}Helper.setDocumentHeight();return false},onEnd:function(e){Helper.unsetDocumentHeight();if(lastMoveOverElement)lastMoveOverElement.classList.remove("p-2")},onAdd:function(e){var id=e.item.getAttribute("data-id"),newDependence=e.to.getAttribute("data-group-id");Storage.update(id,{dependence:newDependence});Storage.update(newDependence,{dependent:this.toArray()})},onRemove:function(e){var oldDependence=e.from.getAttribute("data-group-id");Storage.update(oldDependence,{dependent:this.toArray()})},onUpdate:function(e){var dependence=e.from.getAttribute("data-group-id");Storage.update(dependence,{dependent:this.toArray()})},onMove:function(e){var sortableGroup=e.related.lastElementChild;if(sortableGroup.childElementCount==0&&lastMoveOverElement!==sortableGroup){if(lastMoveOverElement)lastMoveOverElement.classList.remove("p-2");lastMoveOverElement=sortableGroup;sortableGroup.classList.add("p-2")}else if(lastMoveOverElement){lastMoveOverElement.classList.remove("p-2");lastMoveOverElement=null}}})}Event.registerHandler("keyboard","keydown",function(e){if((e.keyCode==13||e.keyCode==32)&&e.target.nodeName=="BUTTON"){if(e.target.hasAttribute("data-action")){e.stopPropagation();e.preventDefault();buttonAction[e.target.getAttribute("data-action")](e.target)}}}).on("keyboard",document);Event.registerHandler("windowResize","resize",function(e){currentScreenWidth=document.documentElement.clientWidth}).on("windowResize",window);Storage.select("0",function(data){makeSortable(getGroupElement("0"),"project");data["dependent"].forEach(function(id){Storage.select(id,put)})});return{create:create,update:update,remove:remove,toggleStatus:toggleStatus,getType:getType}}()})();